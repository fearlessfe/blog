<!doctype html><html lang=en><head><title>The Node.js Event Loop, Timers and process.nextTick() - fearlessfe's blog</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name=renderer content="webkit"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=format-detection content="telephone=no,email=no,adress=no"><meta name=theme-color content="#000000"><meta http-equiv=window-target content="_top"><meta name=description content="ä¸ºä»€ä¹ˆè¦å†™è¿™ç¯‡æ–‡ç«  æœ‰ä¸€æ®µæ—¶é—´ nodejs å·¥ä½œç»å†ï¼Œé¢è¯•æ€»æ˜¯è¢«é—®åˆ° Event Loop,è™½ç„¶çœ‹è¿‡å®˜ç½‘ä¸Šçš„æ–‡ç« ï¼Œå¥ˆä½•æ€»æ˜¯è®°ä¸ä½ï¼Œé¢è¯•ä¹Ÿç­”ä¸ä¸Šæ¥ã€‚å› æ­¤ï¼Œå†™è¿™ç¯‡æ–‡ç« æ¥åŠ "><meta name=generator content="Hugo 0.96.0 with theme pure"><title>The Node.js Event Loop, Timers and process.nextTick() - fearlessfe's blog</title><link rel=stylesheet href=https://fearlessfe.github.io/blog/css/style.min.e64d754037c0ee0ec4e20ab1d6f07740ace61729bc03850559b8caa21ae4a597.css><link rel=stylesheet href=https://cdn.staticfile.org/highlight.js/9.15.10/styles/github.min.css async><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css async><meta property="og:title" content="The Node.js Event Loop, Timers and process.nextTick()"><meta property="og:description" content="ä¸ºä»€ä¹ˆè¦å†™è¿™ç¯‡æ–‡ç«  æœ‰ä¸€æ®µæ—¶é—´ nodejs å·¥ä½œç»å†ï¼Œé¢è¯•æ€»æ˜¯è¢«é—®åˆ° Event Loop,è™½ç„¶çœ‹è¿‡å®˜ç½‘ä¸Šçš„æ–‡ç« ï¼Œå¥ˆä½•æ€»æ˜¯è®°ä¸ä½ï¼Œé¢è¯•ä¹Ÿç­”ä¸ä¸Šæ¥ã€‚å› æ­¤ï¼Œå†™è¿™ç¯‡æ–‡ç« æ¥åŠ "><meta property="og:type" content="article"><meta property="og:url" content="https://fearlessfe.github.io/blog/2022/02/event-loop/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-23T20:59:19+08:00"><meta property="article:modified_time" content="2022-02-23T20:59:19+08:00"><meta itemprop=name content="The Node.js Event Loop, Timers and process.nextTick()"><meta itemprop=description content="ä¸ºä»€ä¹ˆè¦å†™è¿™ç¯‡æ–‡ç«  æœ‰ä¸€æ®µæ—¶é—´ nodejs å·¥ä½œç»å†ï¼Œé¢è¯•æ€»æ˜¯è¢«é—®åˆ° Event Loop,è™½ç„¶çœ‹è¿‡å®˜ç½‘ä¸Šçš„æ–‡ç« ï¼Œå¥ˆä½•æ€»æ˜¯è®°ä¸ä½ï¼Œé¢è¯•ä¹Ÿç­”ä¸ä¸Šæ¥ã€‚å› æ­¤ï¼Œå†™è¿™ç¯‡æ–‡ç« æ¥åŠ "><meta itemprop=datePublished content="2022-02-23T20:59:19+08:00"><meta itemprop=dateModified content="2022-02-23T20:59:19+08:00"><meta itemprop=wordCount content="2836"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="The Node.js Event Loop, Timers and process.nextTick()"><meta name=twitter:description content="ä¸ºä»€ä¹ˆè¦å†™è¿™ç¯‡æ–‡ç«  æœ‰ä¸€æ®µæ—¶é—´ nodejs å·¥ä½œç»å†ï¼Œé¢è¯•æ€»æ˜¯è¢«é—®åˆ° Event Loop,è™½ç„¶çœ‹è¿‡å®˜ç½‘ä¸Šçš„æ–‡ç« ï¼Œå¥ˆä½•æ€»æ˜¯è®°ä¸ä½ï¼Œé¢è¯•ä¹Ÿç­”ä¸ä¸Šæ¥ã€‚å› æ­¤ï¼Œå†™è¿™ç¯‡æ–‡ç« æ¥åŠ "><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body class="main-center theme-black" itemscope itemtype=http://schema.org/WebPage><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=slimContent><div class=navbar-header><div class="profile-block text-center"><a id=avatar href=https://github.com/fearlessfe target=_blank><img class="img-circle img-rotate" src="https://avatars.githubusercontent.com/u/21964308?v=4" width=200 height=200></a><h2 id=name class="hidden-xs hidden-sm">pengzhen</h2><h3 id=title class="hidden-xs hidden-sm hidden-md">Software Engineer</h3><small id=location class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>Wuhan, China</small></div><div class=search id=search-form-wrap><form class="search-form sidebar-form"><div class=input-group><input type=text class="search-form-input form-control" placeholder=Search>
<span class=input-group-btn><button type=submit class="search-form-submit btn btn-flat" onclick=return!1><i class="icon icon-search"></i></button></span></div><div class=ins-search><div class=ins-search-mask></div><div class=ins-search-container><div class=ins-input-wrapper><input type=text class=ins-search-input placeholder="Type something..." x-webkit-speech>
<button type=button class="close ins-close ins-selectable" data-dismiss=modal aria-label=Close><span aria-hidden=true>Ã—</span></button></div><div class=ins-section-wrapper><div class=ins-section-container></div></div></div></div></form></div><button class="navbar-toggle collapsed" type=button data-toggle=collapse data-target=#main-navbar aria-controls=main-navbar aria-expanded=false>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button></div><nav id=main-navbar class="collapse navbar-collapse" itemscope itemtype=http://schema.org/SiteNavigationElement role=navigation><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-home"><a href=/blog/><i class="icon icon-home-fill"></i>
<span class=menu-title>Home</span></a></li><li class="menu-item menu-item-archives"><a href=/blog/posts/><i class="icon icon-archives-fill"></i>
<span class=menu-title>Archives</span></a></li><li class="menu-item menu-item-categories"><a href=/blog/categories/><i class="icon icon-folder"></i>
<span class=menu-title>Categories</span></a></li><li class="menu-item menu-item-tags"><a href=/blog/tags/><i class="icon icon-tags"></i>
<span class=menu-title>Tags</span></a></li></ul></nav></div></header><aside class=sidebar itemscope itemtype=http://schema.org/WPSideBar><div class=slimContent><div class=widget><h3 class=widget-title>Board</h3><div class=widget-body><div id=board><div class=content><p>enjoy~</p></div></div></div></div><div class=widget><h3 class=widget-title>Tags</h3><div id=tag-cloud-list class=widget-body></div><script>document.onreadystatechange=()=>{document.readyState==="complete"&&tagCloud("#tag-cloud-list a",8,20)};function tagCloud(n,s,o){let t=0,e=0;$(n).each(function(){let n=Number($(this).attr("rel"));t<n&&(t=n),(e>n||e==0)&&(e=n)});let i=(o-s)/(t-e);$(n).each(function(){let t=$(this).attr("rel")-e;$(this).css({"font-size":s+t*i+"px"})})}</script></div><div class=widget><h3 class=widget-title>Categories</h3><div class=widget-body><ul class=category-list></ul></div></div><div class=widget><h3 class=widget-title>Tags</h3><div class=widget-body><ul class=tag-list></ul></div></div><div class=widget><h3 class=widget-title>Recent Posts</h3><div class=widget-body><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class=item-inner><p class=item-title><a href=https://fearlessfe.github.io/blog/2022/02/%E6%82%B2%E8%A7%82%E9%94%81%E4%B9%90%E8%A7%82%E9%94%81/ class=title>golang é‡Œé¢çš„ mutex æ˜¯ä»€ä¹ˆç±»å‹çš„é”ï¼Ÿ</a></p><p class=item-date><time datetime="2022-02-24 13:04:25 +0800 +0800" itemprop=datePublished>2022-02-24</time></p></div></li><li><div class=item-inner><p class=item-title><a href=https://fearlessfe.github.io/blog/2022/02/event-loop/ class=title>The Node.js Event Loop, Timers and process.nextTick()</a></p><p class=item-date><time datetime="2022-02-23 20:59:19 +0800 +0800" itemprop=datePublished>2022-02-23</time></p></div></li><li><div class=item-inner><p class=item-title><a href=https://fearlessfe.github.io/blog/2022/01/mutex/ class=title>Golang Mutex æºç è§£æ</a></p><p class=item-date><time datetime="2022-01-22 13:12:08 +0800 +0800" itemprop=datePublished>2022-01-22</time></p></div></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse" id=collapseToc itemscope itemtype=http://schema.org/WPSideBar><div class=slimContent><h4 class=toc-title>Catalogue</h4><nav id=toc class="js-toc toc"></nav></div></aside><main class=main role=main><div class=content><article id=- class="article article-type-" itemscope itemtype=http://schema.org/BlogPosting><div class=article-header><h1 itemprop=name><a class=article-title href=/blog/2022/02/event-loop/>The Node.js Event Loop, Timers and process.nextTick()</a></h1><div class=article-meta><span class=article-date><i class="icon icon-calendar-check"></i>&nbsp;
<a href=https://fearlessfe.github.io/blog/2022/02/event-loop/ class=article-date><time datetime="2022-02-23 20:59:19 +0800 +0800" itemprop=datePublished>2022-02-23</time></a></span>
<span class="post-wordcount hidden-xs" itemprop=wordCount>Word Count: 2836 words</span>
<span class="post-readcount hidden-xs" itemprop=timeRequired>Read Time: 6 minutes</span></div></div><div class="article-entry marked-body js-toc-content" itemprop=articleBody><h3 id=ä¸ºä»€ä¹ˆè¦å†™è¿™ç¯‡æ–‡ç« >ä¸ºä»€ä¹ˆè¦å†™è¿™ç¯‡æ–‡ç« </h3><p>æœ‰ä¸€æ®µæ—¶é—´ <code>nodejs</code> å·¥ä½œç»å†ï¼Œé¢è¯•æ€»æ˜¯è¢«é—®åˆ° <code>Event Loop</code>,è™½ç„¶çœ‹è¿‡å®˜ç½‘ä¸Šçš„æ–‡ç« ï¼Œå¥ˆä½•æ€»æ˜¯è®°ä¸ä½ï¼Œé¢è¯•ä¹Ÿç­”ä¸ä¸Šæ¥ã€‚å› æ­¤ï¼Œå†™è¿™ç¯‡æ–‡ç« æ¥åŠ æ·±å°è±¡ã€‚åŸæ–‡è¯·ğŸ‘‡<a href=https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/>è¿™é‡Œ</a></p><h3 id=ä»€ä¹ˆæ˜¯-event-loop>ä»€ä¹ˆæ˜¯ <code>Event Loop</code></h3><p>è™½ç„¶ <code>Javascript</code> æ˜¯å•çº¿ç¨‹çš„ï¼Œä½†æ˜¯ <code>Event Loop</code> è®© <code>Nodejs</code> èƒ½å¤Ÿæ‰§è¡Œéé˜»å¡çš„ I/Oã€‚</p><p>ç°ä»£å†…æ ¸éƒ½æ˜¯å¤šçº¿ç¨‹çš„ï¼Œå®ƒä»¬å¯åœ¨åå°æ‰§è¡Œå¤šä¸ªæ“ä½œã€‚ä½†å…¶ä¸­ä¸€ä¸ªæ“ä½œå®Œæˆåï¼Œå†…æ ¸é€šçŸ¥ Nodejs ä»¥ä¾¿å°†ç›¸åº”çš„å›è°ƒæ·»åŠ åˆ°è½®è¯¢é˜Ÿåˆ—ï¼Œæœ€åå›è°ƒä¼šè¢«æ‰§è¡Œã€‚</p><h3 id=event-loopç®€ä»‹><code>Event Loop</code>ç®€ä»‹</h3><p>å½“ Nodejs è¿è¡Œæ—¶ï¼Œå®ƒä¼šåˆå§‹åŒ–äº‹ä»¶å¾ªç¯ï¼Œæ‰§è¡Œè¾“å…¥çš„è„šæœ¬ï¼Œè„šæœ¬ä¸­å¯èƒ½ä¼šè°ƒç”¨å¼‚æ­¥çš„ APIï¼Œtimer å‡½æ•°æˆ– <code>process.nextTick()</code>,ç„¶åå¼€å§‹äº‹ä»¶å¾ªç¯ã€‚</p><p>ä¸‹å›¾ï¼ˆæ¥æºäº<a href=https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/>åŸæ–‡</a>ï¼‰ç®€å•çš„æè¿°äº†äº‹ä»¶å¾ªç¯æ“ä½œé¡ºåºã€‚</p><p>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€>â”‚ timers â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”‚ pending callbacks â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”‚ idle, prepare â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ incoming: â”‚
â”‚ â”‚ poll â”‚&lt;â”€â”€â”€â”€â”€â”¤ connections, â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ data, etc. â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”‚ check â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”¤ close callbacks â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</p><blockquote><p>å›¾ä¸­æ¯ä¸ªç›’å­ä»£è¡¨äº‹ä»¶å¾ªç¯ä¸­ä¸€ä¸ª<code>é˜¶æ®µ</code></p></blockquote><p>æ¯ä¸ªé˜¶æ®µéƒ½æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼ŒæŒ‰ç…§ FIFO çš„æ–¹å¼æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚äº‹ä»¶å¾ªç¯è¿›å…¥å…¶ä¸­ä¸€ä¸ªé˜¶æ®µåï¼Œé¦–å…ˆä¼šæ‰§è¡Œè¯¥é˜¶æ®µç‰¹å®šçš„æ“ä½œã€‚ç„¶åæ‰§è¡Œè¯¥é˜¶æ®µé˜Ÿåˆ—ä¸­çš„å›è°ƒï¼ŒçŸ¥é“é˜Ÿåˆ—ä¸­å›è°ƒå…¨éƒ¨æ‰§è¡Œå®Œæˆ–è€…è¾¾åˆ°æœ€å¤§çš„å›è°ƒé™åˆ¶ï¼Œç„¶åäº‹ä»¶å¾ªç¯è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚</p><p>ç”±äºè¿™äº›æ“ä½œå¯èƒ½ä¼šäº§ç”Ÿæ–°çš„äº‹ä»¶ï¼Œè€Œè½®è¯¢é˜¶æ®µï¼ˆpoll phaseï¼‰æ–°çš„äº‹ä»¶ç”±å†…æ ¸åŠ å…¥åˆ°é˜Ÿåˆ—ï¼Œå› æ­¤å¤„ç†è½®è¯¢äº‹ä»¶æ—¶ä¹Ÿä¼šæœ‰æ–°çš„äº‹ä»¶åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚å› æ­¤ï¼Œé•¿æ—¶é—´è¿è¡Œçš„å›è°ƒä¼šè®©è½®è¯¢é˜¶æ®µçš„æ—¶é—´è¿œè¶…è¿‡è®¡æ—¶å™¨çš„é˜ˆå€¼ã€‚</p><h3 id=é˜¶æ®µæ¦‚è§ˆ>é˜¶æ®µæ¦‚è§ˆ</h3><ul><li>timers: è¿™ä¸ªé˜¶æ®µæ‰§è¡Œ <code>setTimeout()</code> å’Œ <code>setInterval()</code> çš„å›è°ƒ</li><li>pending callbacksï¼šæ‰§è¡Œæ¨è¿Ÿåˆ°ä¸‹ä¸€ä¸ªå¾ªç¯çš„ I/O å›è°ƒ</li><li>idle,prepare: ä»…ä¾›å†…éƒ¨ä½¿ç”¨</li><li>pollï¼ˆè½®è¯¢ï¼‰: æ£€ç´¢æ–°çš„ I/O äº‹ä»¶ï¼›æ‰§è¡Œ I/O ç›¸å…³çš„å›è°ƒï¼ˆå‡ ä¹æ‰€æœ‰çš„å›è°ƒï¼Œé™¤äº†å…³é—­å›è°ƒï¼Œå®šæ—¶å™¨è°ƒåº¦çš„å›è°ƒå’Œ<code>setImmediate()</code>ï¼‰,èŠ‚ç‚¹ä¼šåœ¨é€‚å½“çš„æ—¶å€™é˜»å¡ã€‚</li><li>checkï¼š<code>setImmediate()</code>çš„å›è°ƒåœ¨è¿™é‡Œæ‰§è¡Œã€‚</li><li>close callbacks: å…³é—­çš„å›è°ƒï¼Œæ¯”å¦‚<code>socket.on('close',...)</code></li></ul><p>åœ¨äº‹ä»¶å¾ªç¯ä¹‹é—´ï¼ŒNodejs ä¼šæ£€æŸ¥å®ƒæ˜¯å¦æ­£åœ¨ç­‰å¾…å¼‚æ­¥ I/O æˆ–è®¡æ—¶å™¨ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™é€€å‡ºã€‚ï¼ˆè¿™é‡Œé€€å‡ºåº”è¯¥æ˜¯æŒ‡é€€å‡º nodejs ç¨‹åºï¼‰ã€‚</p><h3 id=é˜¶æ®µè¯¦æƒ…>é˜¶æ®µè¯¦æƒ…</h3><h4 id=timers>timers</h4><p>è®¡æ—¶å™¨å¯ä»¥æŒ‡å®šä¸€ä¸ªé˜ˆå€¼ï¼Œåˆ°è¾¾é˜ˆå€¼åæ‰§è¡Œå›è°ƒï¼Œè€Œä¸æ˜¯å†³å®šå›è°ƒæ‰§è¡Œçš„ç¡®åˆ‡æ—¶é—´ã€‚è®¡æ—¶å™¨çš„å›è°ƒä¼šåœ¨æŒ‡å®šçš„æ—¶é—´è¿‡åå°½å¯èƒ½æ—©çš„æ‰§è¡Œï¼Œä½†æ˜¯å›è°ƒçš„æ‰§è¡Œå¯èƒ½ä¼šå»¶è¿Ÿã€‚</p><blockquote><p>è½®è¯¢é˜¶æ®µæ§åˆ¶è®¡æ—¶å™¨å›è°ƒçš„æ‰§è¡Œ</p></blockquote><p>ä¸¾ä¸ªä¾‹å­ï¼Œå®šæ—¶å™¨åœ¨100msåæ‰§è¡Œå›è°ƒï¼Œç„¶åä¸€ä¸ªå¼‚æ­¥è¯»å–æ–‡ä»¶ä¼šèŠ± 95ms</p><pre><code class=language-nodejs>const fs = require('fs');

function someAsyncOperation(callback) {
  fs.readFile('/path/to/file', callback)
}

const timeoutScheduled = Date.now();

setTimeout(() =&gt; {
  const delay = Date.now() - timeoutScheduled
  
  console.log(`${delay}ms have passed since I was scheduled`)
}, 100)

// someAsyncOperation takes 95ms
someAsyncOperation(() =&gt; {
  const startCallback = Date.now()

  // do something will take 10ms
  while(Date.now() - startCallback &lt; 10) {
    // do nothing
  }
})
</code></pre><p>å½“äº‹ä»¶å¾ªç¯è¿›å…¥è½®è¯¢é˜¶æ®µï¼Œæ­¤æ—¶é˜Ÿåˆ—æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥ä¼šç­‰å¾…ä¸€ç›´è¾¾åˆ°æœ€è¿‘çš„è®¡æ—¶å™¨é˜ˆå€¼ã€‚
95ms åï¼Œè¯»å–æ–‡ä»¶çš„æ“ä½œå®Œæˆï¼Œå›è°ƒè¿›å…¥è½®è¯¢é˜¶æ®µçš„é˜Ÿåˆ—ï¼Œç„¶åèŠ± 10ms æ‰§è¡Œå›è°ƒã€‚æ‰§è¡Œå®Œæˆåï¼Œé˜Ÿåˆ—ä¸ºç©ºï¼Œè¿™æ—¶å€™åˆ°è¾¾äº† 100ms çš„é˜ˆå€¼ï¼Œå› æ­¤ä¼šå›åˆ° timer é˜¶æ®µæ‰§è¡Œå®šæ—¶å™¨çš„å›è°ƒã€‚æ‰€ä»¥å®šæ—¶å™¨çš„å›è°ƒä¼šåœ¨ 105ms åè¢«æ‰§è¡Œï¼Œè€Œä¸æ˜¯ 100msã€‚</p><blockquote><p>ä¸ºäº†é˜²æ­¢è½®è¯¢é˜¶æ®µè¿‡é•¿ä½¿å¾—äº‹ä»¶å¾ªç¯é™·å…¥é¥¥é¥¿ï¼Œlibuv å¯¹è½®è¯¢é˜¶æ®µè®¾ç½®å¤„ç†äº‹ä»¶çš„æœ€å¤§å€¼</p></blockquote><h4 id=pending-callbacks>pending callbacks</h4><p>è¿™ä¸ªé˜¶æ®µæ‰§è¡Œç³»ç»Ÿæ“ä½œçš„å›è°ƒï¼Œæ¯”å¦‚ TCP errorã€‚æ¯”å¦‚ä¸€ä¸ª TCP è¿æ¥æ”¶åˆ°äº† <code>ECONNREFUSED</code>,ä¸€äº› *nix çš„ç³»ç»Ÿæƒ³è¦ report è¿™ä¸ªé”™è¯¯ã€‚è¿™äº›äº‹ä»¶çš„å›è°ƒä¼šåœ¨è¿™ä¸ªé˜¶æ®µæ‰§è¡Œã€‚</p><h4 id=idle-prepare>idle prepare</h4><p>è¿™ä¸ªé˜¶æ®µä»…ä¾›å†…éƒ¨ä½¿ç”¨</p><h4 id=pollè½®è¯¢>poll(è½®è¯¢)</h4><p>è½®è¯¢é˜¶æ®µä¸»è¦æœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼š</p><ol><li>è®¡ç®—åº”è¯¥é˜»å¡å’Œè½®è¯¢ I/O çš„æ—¶é—´</li><li>å¤„ç†è½®è¯¢é˜Ÿåˆ—çš„äº‹ä»¶</li></ol><p>å½“äº‹ä»¶å¾ªç¯è¿›å…¥ è½®è¯¢é˜¶æ®µå¹¶ä¸”æ²¡æœ‰å®šæ—¶å™¨ï¼Œå°†å‘ç”Ÿä»¥ä¸‹ä¸¤ä»¶äº‹ä¹‹ä¸€ï¼š</p><ul><li>å¦‚æœè½®è¯¢é˜Ÿåˆ—ä¸æ˜¯ç©ºçš„ï¼Œé‚£äº‹ä»¶å¾ªç¯ä¼šæŒ‰é¡ºåºåŒæ­¥çš„æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„äº‹ä»¶ï¼ŒçŸ¥é“é˜Ÿåˆ—ä¸ºç©ºæˆ–è€…è¾¾åˆ°æœ€å¤§çš„äº‹ä»¶é™åˆ¶</li><li>å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™å¯èƒ½å‘ç”Ÿä¸‹åˆ—ä¸¤ä»¶äº‹ä¹‹ä¸€ï¼š<ul><li>å¦‚æœæœ‰ <code>setImmediate()</code> äº‹ä»¶ï¼Œäº‹ä»¶å¾ªç¯ä¼šç»“æŸè½®è¯¢é˜¶æ®µï¼Œè¿›å…¥ check é˜¶æ®µï¼Œæ‰§è¡Œè¯¥é˜¶æ®µçš„å›è°ƒã€‚</li><li>å¦‚æœæ²¡æœ‰ <code>setImmediate()</code> äº‹ä»¶ï¼Œäº‹ä»¶å¾ªç¯ä¼šç­‰å¾…å›è°ƒè¢«åŠ å…¥åˆ°é˜Ÿåˆ—ï¼Œç„¶åç«‹å³æ‰§è¡Œå›è°ƒ</li></ul></li></ul><p>å¦‚æœè½®è¯¢é˜Ÿåˆ—ä¸ºç©ºï¼Œäº‹ä»¶å¾ªç¯ä¼šæ£€æŸ¥æ˜¯å¦è¾¾åˆ°å®šæ—¶å™¨çš„é˜ˆå€¼ã€‚å¦‚æœæœ‰ï¼Œäº‹ä»¶å¾ªç¯ä¼šå›åˆ° timer é˜¶æ®µï¼Œæ‰§è¡Œå®šæ—¶å™¨çš„å›è°ƒã€‚</p><h4 id=check>check</h4><p>è¿™ä¸ªé˜¶æ®µæ˜¯åœ¨è½®è¯¢é˜¶æ®µç»“æŸåæ‰§è¡Œè¯¥é˜¶æ®µçš„å›è°ƒã€‚</p><p><code>setImmediate()</code>æ˜¯ä¸€ä¸ªç‰¹åˆ«çš„å®šæ—¶å™¨ï¼Œåœ¨å•ç‹¬çš„é˜¶æ®µæ‰§è¡Œã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œä»£ç æ‰§è¡Œåï¼Œäº‹ä»¶å¾ªç¯ä¼šæœ€ç»ˆè¾¾åˆ°è½®è¯¢é˜¶æ®µï¼Œç­‰å¾…æ–°æ¥çš„é“¾æ¥ï¼Œè¯·æ±‚ç­‰ã€‚å¦‚æœæœ‰ <code>setImmediate()</code> è€Œä¸”è½®è¯¢é˜¶æ®µå¤„äºç©ºé—²çŠ¶æ€ï¼Œè½®è¯¢é˜¶æ®µä¼šç»“æŸï¼Œç„¶åè¿›å…¥ check é˜¶æ®µæ‰§è¡Œ <code>setImmediate()</code> çš„å›è°ƒã€‚</p><h4 id=close-callback>close callback</h4><p>å¦‚æœå¥—æ¥å­—æˆ–å¥æŸ„è¢«çªç„¶å…³é—­ï¼ˆä¾‹å¦‚ socket.destroy()ï¼‰,æ­¤é˜¶æ®µä¼š emit &lsquo;close&rsquo; äº‹ä»¶ã€‚å¦åˆ™ä¼šé€šè¿‡ process.nextTick()</p><h3 id=setimmediate-vs-settimeout>setImmediate() VS setTimeout()</h3><p>setImmediate() å’Œ setTimeout() æ¯”è¾ƒç±»ä¼¼ï¼Œä½†æ˜¯æ ¹æ®è°ƒç”¨æ—¶é—´ä¸åŒè€Œæœ‰ä¸åŒçš„è¡¨ç°ã€‚</p><ul><li>setImmediate() è®¾è®¡ä¸º è½®è¯¢é˜¶æ®µç»“æŸåè°ƒç”¨</li><li>setTimeout() è¾¾åˆ°è®¾å®šçš„é˜ˆå€¼åè°ƒç”¨</li></ul><p>å¦‚æœä¸¤è€…éƒ½åœ¨ä¸»æ¨¡å—ä¸­è°ƒç”¨ï¼Œé‚£ä¹ˆä¸¤è€…çš„é¡ºåºæ˜¯ä¸å›ºå®šçš„ï¼Œä¸¤è€…é¡ºåºå–å†³äºå¤„ç†å™¨çš„æ€§èƒ½ã€‚</p><pre><code class=language-nodejs>setTimeout(() =&gt; {
  console.log('timeout)
}, 0)

setImmediate(() =&gt; {
  console.log('immediate)
}, 0)
</code></pre><p>å¦‚æœåœ¨ I/O äº‹ä»¶ä¸­è°ƒç”¨ï¼Œåˆ™ setImmediate æ€»æ˜¯å…ˆæ‰§è¡Œ</p><pre><code class=language-nodejs>const fs = require('fs');

fs.readFile(&quot;&quot;, () =&gt; {
  setTimeout(() =&gt; {
    console.log('timeout)
  }, 0)

  setImmediate(() =&gt; {
    console.log('immediate)
  }, 0)
})

</code></pre><h3 id=processnexttick>process.nextTick()</h3><h4 id=ç†è§£-nexttick>ç†è§£ nextTick</h4><p>process.nextTick() æ²¡æœ‰åœ¨å›¾ä¸­å±•ç¤ºï¼Œå³ä½¿è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ APIã€‚å› ä¸º nextTick ä¸å±äºäº‹ä»¶å¾ªç¯ã€‚</p><p>åœ¨æŸä¸ªé˜¶æ®µçš„ä»»æ„æ—¶åˆ»è°ƒç”¨ process.nextTick()ï¼Œå®ƒçš„å›è°ƒä¼šåœ¨äº‹ä»¶å¾ªç¯ç»§ç»­ä¹‹å‰æ‰§è¡Œã€‚è¿™ä¼šå‡ºç°ä¸€äº›åçš„æƒ…å†µï¼Œæ¯”å¦‚åœ¨ process.nextTick() é€’å½’è°ƒç”¨ process.nextTick()ï¼Œè¿™ä¼šä½¿å¾—äº‹ä»¶å¾ªç¯æ— æ³•ç»§ç»­ã€‚</p><h4 id=ä¸ºä»€ä¹ˆéœ€è¦-nexttick>ä¸ºä»€ä¹ˆéœ€è¦ nextTick</h4><p>nextTick ä¸€éƒ¨åˆ†çš„è®¾è®¡ç†å¿µæ˜¯ API åº”è¯¥å§‹ç»ˆæ˜¯å¼‚æ­¥çš„ï¼Œå³ä½¿å®ƒä¸æ˜¯ã€‚ä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹</p><pre><code class=language-nodejs>function apiCall(arg, callback) {
  if (typeof arg != 'string') {
    return process.nextTick(callback, new TypeError('args should be string'))
  }
}
</code></pre><p>è¿™æ ·å›è°ƒä¼šåœ¨æ‰€æœ‰ç”¨æˆ·çš„ code æ‰§è¡Œå®Œæ¯•åï¼Œåœ¨è¿›å…¥äº‹ä»¶å¾ªç¯ä¹‹å‰æ‰æ‰§è¡Œã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªçœŸæ­£çš„ä¾‹å­</p><pre><code class=language-nodejs>const server = net.createServer(() =&gt; {}).listen(8080)
server.on('listening', () =&gt; {})
</code></pre><p>åªæœ‰ç»‘å®šç«¯å£åï¼Œ &rsquo;listening&rsquo; å›è°ƒæ‰ä¼šæ‰§è¡Œã€‚ä½†é—®é¢˜æ˜¯é‚£æ—¶å€™ &rsquo;listening&rsquo; å›è°ƒè¿˜æ²¡è®¾ç½®ã€‚
æ‰€ä»¥ &rsquo;listening&rsquo; å›è°ƒæ”¾åœ¨ nextTick() ä¸­ã€‚</p><h3 id=processnexttick-vs-setimmediate>process.nextTick() VS setImmediate()</h3><p>è¿™ä¸¤è€…æ¯”è¾ƒç±»ä¼¼ï¼Œä½†æ˜¯åå­—æœ‰ç‚¹è®©äººå›°æƒ‘</p><ul><li>process.nextTick() åœ¨å½“å‰é˜¶æ®µæ‰§è¡Œ</li><li>setImmediate() åœ¨æ—¶é—´å¾ªç¯ä¸­æ‰§è¡Œ</li></ul><blockquote><p>å»ºè®®å¼€å‘è€…åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½ä½¿ç”¨ setImmediate()</p></blockquote><h3 id=ä¸ºä»€ä¹ˆéœ€è¦-processnexttick>ä¸ºä»€ä¹ˆéœ€è¦ process.nextTick()</h3><p>ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªåŸå› </p><ol><li>å…è®¸ç”¨æˆ·å¤„ç†é”™è¯¯ï¼Œæ¸…ç†ä¸éœ€è¦çš„èµ„æºæˆ–åœ¨äº‹ä»¶å¾ªç¯ä¹‹å‰å†æ¬¡å°è¯•è¯·æ±‚</li><li>æœ‰æ—¶ï¼Œéœ€è¦å…è®¸å›è°ƒåœ¨è°ƒç”¨æ ˆè§£é™¤åä½†åœ¨äº‹ä»¶å¾ªç¯ä¹‹å‰è°ƒç”¨</li></ol><p>ä¸€ä¸ªç¬¦åˆç”¨æˆ·æœŸæœ›çš„ä¾‹å­å¦‚ä¸‹</p><pre><code class=language-nodejs>const server = net.createServer();
server.on('connection', (conn) =&gt; {})

server.listen(8000)
server.on('listening', () =&gt; {})
</code></pre><p>listen() åœ¨æ—¶é—´å¾ªç¯å¼€å§‹æ—¶å…è®¸ï¼Œå¦‚æœ &rsquo;listening&rsquo; å‡½æ•°æ”¾åœ¨ setImmediate ä¸­ï¼Œé‚£ä¹ˆæœ‰ä¸€å®šæ¦‚ç‡åœ¨è½®è¯¢é˜¶æ®µæ”¶åˆ°æ–°çš„è¯·æ±‚çš„æ—¶å€™ï¼Œ&rsquo;listening&rsquo; å›è°ƒè¿˜æ²¡æœ‰æ³¨å†Œã€‚</p><p>å¦ä¸€ä¸ªä¾‹å­æ˜¯åœ¨æ„é€ å‡½æ•°ä¸­ emit äº‹ä»¶</p><pre><code class=language-nodejs>const EventEmitter =  require('events')
const util = require('util')

function MyEmitter() {
  EventEmitter.call(this)
  this.emit('event)
}

util.inherits(MyEmitter, EventEmitter)

const myEmitter = new MyEmitter();
myEmitter.on('event', () =&gt; {
  console.log('event occurred!')
})
</code></pre><p>ä¸Šè¯‰ä»£ç ä¸­çš„äº‹ä»¶ä¸ä¼šè§¦å‘ï¼Œå› ä¸ºè„šæœ¬ä¸ä¼šå¤„ç†åˆ°ä¸ºäº‹ä»¶åˆ†é…å›è°ƒçš„åœ°æ–¹ã€‚å¦‚æœå°† this.emit(&rsquo;event) æ”¾å…¥ process.nextTick() ä¸­æ‰§è¡Œï¼Œåˆ™ä¼šè§¦å‘ &rsquo;event&rsquo; äº‹ä»¶ã€‚</p></div><div class=article-footer><blockquote class=mt-2x><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>Permalink:</strong>
<a href=https://fearlessfe.github.io/blog/2022/02/event-loop/ title="The Node.js Event Loop, Timers and process.nextTick()" target=_blank rel=external>https://fearlessfe.github.io/blog/2022/02/event-loop/</a></li><li class=post-copyright-license><strong>License:</strong>
<a href=http://creativecommons.org/licenses/by/4.0/deed.zh target=_blank rel=external>CC BY 4.0 CN</a></li></ul></blockquote><div class="panel panel-default panel-badger"><div class=panel-body><figure class=media><div class=media-left><a href=https://github.com/fearlessfe target=_blank class="img-burn thumb-sm visible-lg"><img src="https://avatars.githubusercontent.com/u/21964308?v=4" class="img-rounded w-full" alt></a></div><div class=media-body><h3 class=media-heading><a href=https://github.com/fearlessfe target=_blank><span class=text-dark>pengzhen</span><small class=ml-1x>Software Engineer</small></a></h3><div>Good judgement comes from experience, and experience comes from bad judgement.</div></div></figure></div></div></div></article></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class=bar-inner><ul class="pager pull-left"><li class=prev><a href=https://fearlessfe.github.io/blog/2022/01/mutex/ title="Golang Mutex æºç è§£æ"><i class="icon icon-angle-left" aria-hidden=true></i><span>&nbsp;&nbsp;Older</span></a></li><li class=next><a href=https://fearlessfe.github.io/blog/2022/02/%E6%82%B2%E8%A7%82%E9%94%81%E4%B9%90%E8%A7%82%E9%94%81/ title="golang é‡Œé¢çš„ mutex æ˜¯ä»€ä¹ˆç±»å‹çš„é”ï¼Ÿ"><span>Newer&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden=true></i></a></li><li class=toggle-toc><a class="toggle-btn collapsed" data-toggle=collapse href=#collapseToc aria-expanded=false title=Catalogue role=button><span>[&nbsp;</span><span>Catalogue</span>
<i class="text-collapsed icon icon-anchor"></i>
<i class="text-in icon icon-close"></i>
<span>]</span></a></li></ul><div class=bar-right><div class=share-component data-sites=weibo,qq,wechat,facebook,twitter data-mobile-sites=weibo,qq,qzone></div></div></div></nav></main><footer class=footer itemscope itemtype=http://schema.org/WPFooter><ul class=social-links><li><a href=https://github.com/fearlessfe target=_blank title=github data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li><li><a href=https://fearlessfe.github.io/index.xml target=_blank title=rss data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li></ul><div class=copyright>&copy;2022 -
2022<div class=publishby>Theme by <a href=https://github.com/xiaoheiAh target=_blank>xiaoheiAh </a>base on<a href=https://github.com/xiaoheiAh/hugo-theme-pure target=_blank> pure</a>.</div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
<script type=text/x-mathjax-config>
    MathJax.Hub.Config({
            showMathMenu: false, //disables context menu
            tex2jax: {
            inlineMath: [ ['$','$'], ['\\(','\\)'] ]
           }
    });
</script><script src=https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js></script>
<script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script type=text/javascript src=https://cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js></script>
<script type=text/javascript src=https://cdn.staticfile.org/highlight.js/9.15.10/languages/golang.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/highlight.js/9.15.10/languages/javascript.min.js defer></script><script>hljs.configure({tabReplace:"    ",classPrefix:''}),hljs.initHighlightingOnLoad()</script>
<script src=https://fearlessfe.github.io/blog/js/application.min.e720b935330b2a176cfb4b8bd9a6cc632caf6b752f94e87c62152a9557ff6d15.js></script>
<script src=https://fearlessfe.github.io/blog/js/plugin.min.334875d4d4a72afb866e446df61b5f4bf1f0a516d1303166f52f7804d17ef3ab.js></script>
<script>(function(e){var t={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)"},ROOT_URL:"https://fearlessfe.github.io/blog/",CONTENT_URL:"https://fearlessfe.github.io/blog//searchindex.json "};e.INSIGHT_CONFIG=t})(window)</script><script type=text/javascript src=https://fearlessfe.github.io/blog/js/insight.min.759e5002714e12761afcd512f103d39c86573165db51972dd3b24df6eddf238ed3e3e85c1988e96cba09419d1deccdeb68c15284f2c3d03049fad53c11774524.js defer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js></script>
<script>tocbot.init({tocSelector:".js-toc",contentSelector:".js-toc-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0})</script></body></html>