---
title: "The Node.js Event Loop, Timers and process.nextTick()"
date: 2022-02-23T20:59:19+08:00
draft: false
---

### ä¸ºä»€ä¹ˆè¦å†™è¿™ç¯‡æ–‡ç« 

æœ‰ä¸€æ®µæ—¶é—´ `nodejs` å·¥ä½œç»å†ï¼Œé¢è¯•æ€»æ˜¯è¢«é—®åˆ° `Event Loop`,è™½ç„¶çœ‹è¿‡å®˜ç½‘ä¸Šçš„æ–‡ç« ï¼Œå¥ˆä½•æ€»æ˜¯è®°ä¸ä½ï¼Œé¢è¯•ä¹Ÿç­”ä¸ä¸Šæ¥ã€‚å› æ­¤ï¼Œå†™è¿™ç¯‡æ–‡ç« æ¥åŠ æ·±å°è±¡ã€‚åŸæ–‡è¯·ğŸ‘‡[è¿™é‡Œ](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/)

### ä»€ä¹ˆæ˜¯ `Event Loop`

è™½ç„¶ `Javascript` æ˜¯å•çº¿ç¨‹çš„ï¼Œä½†æ˜¯ `Event Loop` è®© `Nodejs` èƒ½å¤Ÿæ‰§è¡Œéé˜»å¡çš„ I/Oã€‚

ç°ä»£å†…æ ¸éƒ½æ˜¯å¤šçº¿ç¨‹çš„ï¼Œå®ƒä»¬å¯åœ¨åå°æ‰§è¡Œå¤šä¸ªæ“ä½œã€‚ä½†å…¶ä¸­ä¸€ä¸ªæ“ä½œå®Œæˆåï¼Œå†…æ ¸é€šçŸ¥ Nodejs ä»¥ä¾¿å°†ç›¸åº”çš„å›è°ƒæ·»åŠ åˆ°è½®è¯¢é˜Ÿåˆ—ï¼Œæœ€åå›è°ƒä¼šè¢«æ‰§è¡Œã€‚

### `Event Loop`ç®€ä»‹

å½“ Nodejs è¿è¡Œæ—¶ï¼Œå®ƒä¼šåˆå§‹åŒ–äº‹ä»¶å¾ªç¯ï¼Œæ‰§è¡Œè¾“å…¥çš„è„šæœ¬ï¼Œè„šæœ¬ä¸­å¯èƒ½ä¼šè°ƒç”¨å¼‚æ­¥çš„ APIï¼Œtimer å‡½æ•°æˆ– `process.nextTick()`,ç„¶åå¼€å§‹äº‹ä»¶å¾ªç¯ã€‚

ä¸‹å›¾ï¼ˆæ¥æºäº[åŸæ–‡](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/)ï¼‰ç®€å•çš„æè¿°äº†äº‹ä»¶å¾ªç¯æ“ä½œé¡ºåºã€‚

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€>â”‚           timers          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚     pending callbacks     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚       idle, prepare       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   incoming:   â”‚
â”‚  â”‚           poll            â”‚<â”€â”€â”€â”€â”€â”¤  connections, â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   data, etc.  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚           check           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”¤      close callbacks      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
> å›¾ä¸­æ¯ä¸ªç›’å­ä»£è¡¨äº‹ä»¶å¾ªç¯ä¸­ä¸€ä¸ª`é˜¶æ®µ`

æ¯ä¸ªé˜¶æ®µéƒ½æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼ŒæŒ‰ç…§ FIFO çš„æ–¹å¼æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚äº‹ä»¶å¾ªç¯è¿›å…¥å…¶ä¸­ä¸€ä¸ªé˜¶æ®µåï¼Œé¦–å…ˆä¼šæ‰§è¡Œè¯¥é˜¶æ®µç‰¹å®šçš„æ“ä½œã€‚ç„¶åæ‰§è¡Œè¯¥é˜¶æ®µé˜Ÿåˆ—ä¸­çš„å›è°ƒï¼ŒçŸ¥é“é˜Ÿåˆ—ä¸­å›è°ƒå…¨éƒ¨æ‰§è¡Œå®Œæˆ–è€…è¾¾åˆ°æœ€å¤§çš„å›è°ƒé™åˆ¶ï¼Œç„¶åäº‹ä»¶å¾ªç¯è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚

ç”±äºè¿™äº›æ“ä½œå¯èƒ½ä¼šäº§ç”Ÿæ–°çš„äº‹ä»¶ï¼Œè€Œè½®è¯¢é˜¶æ®µï¼ˆpoll phaseï¼‰æ–°çš„äº‹ä»¶ç”±å†…æ ¸åŠ å…¥åˆ°é˜Ÿåˆ—ï¼Œå› æ­¤å¤„ç†è½®è¯¢äº‹ä»¶æ—¶ä¹Ÿä¼šæœ‰æ–°çš„äº‹ä»¶åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚å› æ­¤ï¼Œé•¿æ—¶é—´è¿è¡Œçš„å›è°ƒä¼šè®©è½®è¯¢é˜¶æ®µçš„æ—¶é—´è¿œè¶…è¿‡è®¡æ—¶å™¨çš„é˜ˆå€¼ã€‚

### é˜¶æ®µæ¦‚è§ˆ

* timers: è¿™ä¸ªé˜¶æ®µæ‰§è¡Œ `setTimeout()` å’Œ `setInterval()` çš„å›è°ƒ
* pending callbacksï¼šæ‰§è¡Œæ¨è¿Ÿåˆ°ä¸‹ä¸€ä¸ªå¾ªç¯çš„ I/O å›è°ƒ
* idle,prepare: ä»…ä¾›å†…éƒ¨ä½¿ç”¨
* pollï¼ˆè½®è¯¢ï¼‰: æ£€ç´¢æ–°çš„ I/O äº‹ä»¶ï¼›æ‰§è¡Œ I/O ç›¸å…³çš„å›è°ƒï¼ˆå‡ ä¹æ‰€æœ‰çš„å›è°ƒï¼Œé™¤äº†å…³é—­å›è°ƒï¼Œå®šæ—¶å™¨è°ƒåº¦çš„å›è°ƒå’Œ`setImmediate()`ï¼‰,èŠ‚ç‚¹ä¼šåœ¨é€‚å½“çš„æ—¶å€™é˜»å¡ã€‚
* checkï¼š`setImmediate()`çš„å›è°ƒåœ¨è¿™é‡Œæ‰§è¡Œã€‚
* close callbacks: å…³é—­çš„å›è°ƒï¼Œæ¯”å¦‚`socket.on('close',...)`

åœ¨äº‹ä»¶å¾ªç¯ä¹‹é—´ï¼ŒNodejs ä¼šæ£€æŸ¥å®ƒæ˜¯å¦æ­£åœ¨ç­‰å¾…å¼‚æ­¥ I/O æˆ–è®¡æ—¶å™¨ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™é€€å‡ºã€‚ï¼ˆè¿™é‡Œé€€å‡ºåº”è¯¥æ˜¯æŒ‡é€€å‡º nodejs ç¨‹åºï¼‰ã€‚

### é˜¶æ®µè¯¦æƒ…

#### timers

è®¡æ—¶å™¨å¯ä»¥æŒ‡å®šä¸€ä¸ªé˜ˆå€¼ï¼Œåˆ°è¾¾é˜ˆå€¼åæ‰§è¡Œå›è°ƒï¼Œè€Œä¸æ˜¯å†³å®šå›è°ƒæ‰§è¡Œçš„ç¡®åˆ‡æ—¶é—´ã€‚è®¡æ—¶å™¨çš„å›è°ƒä¼šåœ¨æŒ‡å®šçš„æ—¶é—´è¿‡åå°½å¯èƒ½æ—©çš„æ‰§è¡Œï¼Œä½†æ˜¯å›è°ƒçš„æ‰§è¡Œå¯èƒ½ä¼šå»¶è¿Ÿã€‚

> è½®è¯¢é˜¶æ®µæ§åˆ¶è®¡æ—¶å™¨å›è°ƒçš„æ‰§è¡Œ

ä¸¾ä¸ªä¾‹å­ï¼Œå®šæ—¶å™¨åœ¨100msåæ‰§è¡Œå›è°ƒï¼Œç„¶åä¸€ä¸ªå¼‚æ­¥è¯»å–æ–‡ä»¶ä¼šèŠ± 95ms

```nodejs
const fs = require('fs');

function someAsyncOperation(callback) {
  fs.readFile('/path/to/file', callback)
}

const timeoutScheduled = Date.now();

setTimeout(() => {
  const delay = Date.now() - timeoutScheduled
  
  console.log(`${delay}ms have passed since I was scheduled`)
}, 100)

// someAsyncOperation takes 95ms
someAsyncOperation(() => {
  const startCallback = Date.now()

  // do something will take 10ms
  while(Date.now() - startCallback < 10) {
    // do nothing
  }
})
```

å½“äº‹ä»¶å¾ªç¯è¿›å…¥è½®è¯¢é˜¶æ®µï¼Œæ­¤æ—¶é˜Ÿåˆ—æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥ä¼šç­‰å¾…ä¸€ç›´è¾¾åˆ°æœ€è¿‘çš„è®¡æ—¶å™¨é˜ˆå€¼ã€‚
95ms åï¼Œè¯»å–æ–‡ä»¶çš„æ“ä½œå®Œæˆï¼Œå›è°ƒè¿›å…¥è½®è¯¢é˜¶æ®µçš„é˜Ÿåˆ—ï¼Œç„¶åèŠ± 10ms æ‰§è¡Œå›è°ƒã€‚æ‰§è¡Œå®Œæˆåï¼Œé˜Ÿåˆ—ä¸ºç©ºï¼Œè¿™æ—¶å€™åˆ°è¾¾äº† 100ms çš„é˜ˆå€¼ï¼Œå› æ­¤ä¼šå›åˆ° timer é˜¶æ®µæ‰§è¡Œå®šæ—¶å™¨çš„å›è°ƒã€‚æ‰€ä»¥å®šæ—¶å™¨çš„å›è°ƒä¼šåœ¨ 105ms åè¢«æ‰§è¡Œï¼Œè€Œä¸æ˜¯ 100msã€‚

> ä¸ºäº†é˜²æ­¢è½®è¯¢é˜¶æ®µè¿‡é•¿ä½¿å¾—äº‹ä»¶å¾ªç¯é™·å…¥é¥¥é¥¿ï¼Œlibuv å¯¹è½®è¯¢é˜¶æ®µè®¾ç½®å¤„ç†äº‹ä»¶çš„æœ€å¤§å€¼

#### pending callbacks

è¿™ä¸ªé˜¶æ®µæ‰§è¡Œç³»ç»Ÿæ“ä½œçš„å›è°ƒï¼Œæ¯”å¦‚ TCP errorã€‚æ¯”å¦‚ä¸€ä¸ª TCP è¿æ¥æ”¶åˆ°äº† `ECONNREFUSED`,ä¸€äº› *nix çš„ç³»ç»Ÿæƒ³è¦ report è¿™ä¸ªé”™è¯¯ã€‚è¿™äº›äº‹ä»¶çš„å›è°ƒä¼šåœ¨è¿™ä¸ªé˜¶æ®µæ‰§è¡Œã€‚

#### idle prepare

è¿™ä¸ªé˜¶æ®µä»…ä¾›å†…éƒ¨ä½¿ç”¨

#### poll(è½®è¯¢)

è½®è¯¢é˜¶æ®µä¸»è¦æœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼š

1. è®¡ç®—åº”è¯¥é˜»å¡å’Œè½®è¯¢ I/O çš„æ—¶é—´
2. å¤„ç†è½®è¯¢é˜Ÿåˆ—çš„äº‹ä»¶

å½“äº‹ä»¶å¾ªç¯è¿›å…¥ è½®è¯¢é˜¶æ®µå¹¶ä¸”æ²¡æœ‰å®šæ—¶å™¨ï¼Œå°†å‘ç”Ÿä»¥ä¸‹ä¸¤ä»¶äº‹ä¹‹ä¸€ï¼š

* å¦‚æœè½®è¯¢é˜Ÿåˆ—ä¸æ˜¯ç©ºçš„ï¼Œé‚£äº‹ä»¶å¾ªç¯ä¼šæŒ‰é¡ºåºåŒæ­¥çš„æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„äº‹ä»¶ï¼ŒçŸ¥é“é˜Ÿåˆ—ä¸ºç©ºæˆ–è€…è¾¾åˆ°æœ€å¤§çš„äº‹ä»¶é™åˆ¶
* å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™å¯èƒ½å‘ç”Ÿä¸‹åˆ—ä¸¤ä»¶äº‹ä¹‹ä¸€ï¼š
  * å¦‚æœæœ‰ `setImmediate()` äº‹ä»¶ï¼Œäº‹ä»¶å¾ªç¯ä¼šç»“æŸè½®è¯¢é˜¶æ®µï¼Œè¿›å…¥ check é˜¶æ®µï¼Œæ‰§è¡Œè¯¥é˜¶æ®µçš„å›è°ƒã€‚
  * å¦‚æœæ²¡æœ‰ `setImmediate()` äº‹ä»¶ï¼Œäº‹ä»¶å¾ªç¯ä¼šç­‰å¾…å›è°ƒè¢«åŠ å…¥åˆ°é˜Ÿåˆ—ï¼Œç„¶åç«‹å³æ‰§è¡Œå›è°ƒ

å¦‚æœè½®è¯¢é˜Ÿåˆ—ä¸ºç©ºï¼Œäº‹ä»¶å¾ªç¯ä¼šæ£€æŸ¥æ˜¯å¦è¾¾åˆ°å®šæ—¶å™¨çš„é˜ˆå€¼ã€‚å¦‚æœæœ‰ï¼Œäº‹ä»¶å¾ªç¯ä¼šå›åˆ° timer é˜¶æ®µï¼Œæ‰§è¡Œå®šæ—¶å™¨çš„å›è°ƒã€‚

#### check

è¿™ä¸ªé˜¶æ®µæ˜¯åœ¨è½®è¯¢é˜¶æ®µç»“æŸåæ‰§è¡Œè¯¥é˜¶æ®µçš„å›è°ƒã€‚

`setImmediate()`æ˜¯ä¸€ä¸ªç‰¹åˆ«çš„å®šæ—¶å™¨ï¼Œåœ¨å•ç‹¬çš„é˜¶æ®µæ‰§è¡Œã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œä»£ç æ‰§è¡Œåï¼Œäº‹ä»¶å¾ªç¯ä¼šæœ€ç»ˆè¾¾åˆ°è½®è¯¢é˜¶æ®µï¼Œç­‰å¾…æ–°æ¥çš„é“¾æ¥ï¼Œè¯·æ±‚ç­‰ã€‚å¦‚æœæœ‰ `setImmediate()` è€Œä¸”è½®è¯¢é˜¶æ®µå¤„äºç©ºé—²çŠ¶æ€ï¼Œè½®è¯¢é˜¶æ®µä¼šç»“æŸï¼Œç„¶åè¿›å…¥ check é˜¶æ®µæ‰§è¡Œ `setImmediate()` çš„å›è°ƒã€‚

#### close callback

å¦‚æœå¥—æ¥å­—æˆ–å¥æŸ„è¢«çªç„¶å…³é—­ï¼ˆä¾‹å¦‚ socket.destroy()ï¼‰,æ­¤é˜¶æ®µä¼š emit 'close' äº‹ä»¶ã€‚å¦åˆ™ä¼šé€šè¿‡ process.nextTick()


### setImmediate() VS setTimeout()

setImmediate() å’Œ setTimeout() æ¯”è¾ƒç±»ä¼¼ï¼Œä½†æ˜¯æ ¹æ®è°ƒç”¨æ—¶é—´ä¸åŒè€Œæœ‰ä¸åŒçš„è¡¨ç°ã€‚

* setImmediate() è®¾è®¡ä¸º è½®è¯¢é˜¶æ®µç»“æŸåè°ƒç”¨
* setTimeout() è¾¾åˆ°è®¾å®šçš„é˜ˆå€¼åè°ƒç”¨

å¦‚æœä¸¤è€…éƒ½åœ¨ä¸»æ¨¡å—ä¸­è°ƒç”¨ï¼Œé‚£ä¹ˆä¸¤è€…çš„é¡ºåºæ˜¯ä¸å›ºå®šçš„ï¼Œä¸¤è€…é¡ºåºå–å†³äºå¤„ç†å™¨çš„æ€§èƒ½ã€‚

```nodejs
setTimeout(() => {
  console.log('timeout)
}, 0)

setImmediate(() => {
  console.log('immediate)
}, 0)
```

å¦‚æœåœ¨ I/O äº‹ä»¶ä¸­è°ƒç”¨ï¼Œåˆ™ setImmediate æ€»æ˜¯å…ˆæ‰§è¡Œ

```nodejs
const fs = require('fs');

fs.readFile("", () => {
  setTimeout(() => {
    console.log('timeout)
  }, 0)

  setImmediate(() => {
    console.log('immediate)
  }, 0)
})

```

### process.nextTick()

#### ç†è§£ nextTick

process.nextTick() æ²¡æœ‰åœ¨å›¾ä¸­å±•ç¤ºï¼Œå³ä½¿è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ APIã€‚å› ä¸º nextTick ä¸å±äºäº‹ä»¶å¾ªç¯ã€‚

åœ¨æŸä¸ªé˜¶æ®µçš„ä»»æ„æ—¶åˆ»è°ƒç”¨ process.nextTick()ï¼Œå®ƒçš„å›è°ƒä¼šåœ¨äº‹ä»¶å¾ªç¯ç»§ç»­ä¹‹å‰æ‰§è¡Œã€‚è¿™ä¼šå‡ºç°ä¸€äº›åçš„æƒ…å†µï¼Œæ¯”å¦‚åœ¨ process.nextTick() é€’å½’è°ƒç”¨ process.nextTick()ï¼Œè¿™ä¼šä½¿å¾—äº‹ä»¶å¾ªç¯æ— æ³•ç»§ç»­ã€‚

#### ä¸ºä»€ä¹ˆéœ€è¦ nextTick

nextTick ä¸€éƒ¨åˆ†çš„è®¾è®¡ç†å¿µæ˜¯ API åº”è¯¥å§‹ç»ˆæ˜¯å¼‚æ­¥çš„ï¼Œå³ä½¿å®ƒä¸æ˜¯ã€‚ä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹

```nodejs
function apiCall(arg, callback) {
  if (typeof arg != 'string') {
    return process.nextTick(callback, new TypeError('args should be string'))
  }
}
```

è¿™æ ·å›è°ƒä¼šåœ¨æ‰€æœ‰ç”¨æˆ·çš„ code æ‰§è¡Œå®Œæ¯•åï¼Œåœ¨è¿›å…¥äº‹ä»¶å¾ªç¯ä¹‹å‰æ‰æ‰§è¡Œã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªçœŸæ­£çš„ä¾‹å­

```nodejs
const server = net.createServer(() => {}).listen(8080)
server.on('listening', () => {})
```

åªæœ‰ç»‘å®šç«¯å£åï¼Œ 'listening' å›è°ƒæ‰ä¼šæ‰§è¡Œã€‚ä½†é—®é¢˜æ˜¯é‚£æ—¶å€™ 'listening' å›è°ƒè¿˜æ²¡è®¾ç½®ã€‚
æ‰€ä»¥ 'listening' å›è°ƒæ”¾åœ¨ nextTick() ä¸­ã€‚

### process.nextTick() VS setImmediate()

è¿™ä¸¤è€…æ¯”è¾ƒç±»ä¼¼ï¼Œä½†æ˜¯åå­—æœ‰ç‚¹è®©äººå›°æƒ‘

* process.nextTick() åœ¨å½“å‰é˜¶æ®µæ‰§è¡Œ
* setImmediate() åœ¨æ—¶é—´å¾ªç¯ä¸­æ‰§è¡Œ

> å»ºè®®å¼€å‘è€…åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½ä½¿ç”¨ setImmediate()

### ä¸ºä»€ä¹ˆéœ€è¦ process.nextTick()

ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªåŸå› 

1. å…è®¸ç”¨æˆ·å¤„ç†é”™è¯¯ï¼Œæ¸…ç†ä¸éœ€è¦çš„èµ„æºæˆ–åœ¨äº‹ä»¶å¾ªç¯ä¹‹å‰å†æ¬¡å°è¯•è¯·æ±‚
2. æœ‰æ—¶ï¼Œéœ€è¦å…è®¸å›è°ƒåœ¨è°ƒç”¨æ ˆè§£é™¤åä½†åœ¨äº‹ä»¶å¾ªç¯ä¹‹å‰è°ƒç”¨

ä¸€ä¸ªç¬¦åˆç”¨æˆ·æœŸæœ›çš„ä¾‹å­å¦‚ä¸‹

```nodejs
const server = net.createServer();
server.on('connection', (conn) => {})

server.listen(8000)
server.on('listening', () => {})
```

listen() åœ¨æ—¶é—´å¾ªç¯å¼€å§‹æ—¶å…è®¸ï¼Œå¦‚æœ 'listening' å‡½æ•°æ”¾åœ¨ setImmediate ä¸­ï¼Œé‚£ä¹ˆæœ‰ä¸€å®šæ¦‚ç‡åœ¨è½®è¯¢é˜¶æ®µæ”¶åˆ°æ–°çš„è¯·æ±‚çš„æ—¶å€™ï¼Œ'listening' å›è°ƒè¿˜æ²¡æœ‰æ³¨å†Œã€‚

å¦ä¸€ä¸ªä¾‹å­æ˜¯åœ¨æ„é€ å‡½æ•°ä¸­ emit äº‹ä»¶

```nodejs
const EventEmitter =  require('events')
const util = require('util')

function MyEmitter() {
  EventEmitter.call(this)
  this.emit('event)
}

util.inherits(MyEmitter, EventEmitter)

const myEmitter = new MyEmitter();
myEmitter.on('event', () => {
  console.log('event occurred!')
})
```

ä¸Šè¯‰ä»£ç ä¸­çš„äº‹ä»¶ä¸ä¼šè§¦å‘ï¼Œå› ä¸ºè„šæœ¬ä¸ä¼šå¤„ç†åˆ°ä¸ºäº‹ä»¶åˆ†é…å›è°ƒçš„åœ°æ–¹ã€‚å¦‚æœå°† this.emit('event) æ”¾å…¥ process.nextTick() ä¸­æ‰§è¡Œï¼Œåˆ™ä¼šè§¦å‘ 'event' äº‹ä»¶ã€‚